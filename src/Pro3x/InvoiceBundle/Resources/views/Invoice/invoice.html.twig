{% extends '::base.html.twig' %}

{% block header %}
    <script src="http://www.google.com/cloudprint/client/cpgadget.js"></script>
    <style type="text/css">
	.ui-menu 
	    { position: absolute; width: 200px; margin-top: 10px; }
	    
	.ui-dialog-content
	    { padding: 2px 0px 2px 0px !important; }
            
        .pro3x-editable-invoice .invoice-item-description:hover
            { color: #2a6496; cursor: pointer; }
    </style>
{% endblock %}

{% block page_title %}
    
    <span class="col-md-8" style="padding-left: 0px;">
        <img src="{{ asset('icons/small/invoice_add.png') }}" />{% include 'Pro3xInvoiceBundle:Invoice:invoice-title.html.twig' %}
        / <a href="{{ path('edit_location', {'id': invoice.position.location.id, 'back': app.request.uri }) }}">{{ invoice.position.location.name }}</a>
        / <a href="{{ path('edit_position', {'id': invoice.position.id, 'back': app.request.uri}) }}">{{ invoice.position.name }}</a>
    </span>

    <span class="col-md-4" style="text-align: right; padding-right: 8px;">
        <small class="pro3x_subtitle">
            {% if invoice.customer %} <a href="{{ path('edit_client', {'id': invoice.customer.id, 'back': app.request.uri}) }}">{{ invoice.customer.name }}</a> 
                | <a href="{{ path('customer_history', {'customer': invoice.customer.id, 'back': app.request.uri}) }}">Kartica</a>
            {% endif %}
        </small>
    </span>
        
    <div class="clearfix"></div>
    
{% endblock %}

{% block body %}
    
    <div style="margin-bottom: 15px;" class="col-md-12 paragon-box {{ invoice.originalInvoiceNumber?'':'hidden' }}">
        <div style="padding-right: 8px; text-align: right;">Paragon : <span class="paragon">{{ invoice.originalInvoiceNumber }}</span></div>
    </div>
    
    
    <div class="col-md-12" style="margin-bottom: 0.6em;">

        {% include '::message.html.twig' %}

        <form>
            <div class="panel panel-default pro3x-table-panel">
                <table class="table table-striped table-hover table-bordered {{ (invoice.sequence == null and invoice.tenderSequence == null)?'pro3x-editable-invoice':'' }}">
                <thead>
                    <tr>
                            <th class="ui-widget-header ui-corner-all" style="width: 350px;">{{ 'Naziv artikla'|trans }}</th>
                            <th class="ui-widget-header ui-corner-all">{{ 'Jedinična cijena'|trans }}</th>
                            <th class="ui-widget-header ui-corner-all">{{ 'Količina'|trans }}</th>
                            <th class="ui-widget-header ui-corner-all">{{ 'Osnovica'|trans }}</th>
                            <th class="ui-widget-header ui-corner-all">{{ 'Popust'|trans }}</th>
                            <th class="ui-widget-header ui-corner-all">{{ 'Ukupno'|trans }}</th>
                    </tr>
                </thead>

                <tbody class="pro3x_invoice_items">
                {% for item in invoice.items %}
                        {% include 'Pro3xInvoiceBundle:Invoice:addItem.html.twig' with {'item': item} %}
                {% else %}
                    <tr>		    
                        <td colspan="100" class="pro3x_no_data">{{ 'Upišite barkod ili šifru artikla i kliknite enter ili gumb Dodaj'|trans }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>
        </form>
    </div>

    <div class="clearfix"></div>

    <div class="pro3x-table-buttons pro3x-document-actions">
        <div class="col-md-9">
            <form id="add_invoice_form" autocomplete="off" class="form-horizontal" action="{{ path('add_invoice_item') }}">
                {% include 'Pro3xInvoiceBundle:Invoice:invoice-actions.html.twig' %}
            </form>
        </div>
        <div class="col-md-3">
            <h2 style="text-align: right; margin-top: 2px; margin-right: 8px;">
                <small style="margin-right: 10px;">{{ 'Ukupno:'|trans }}</small><span class="pro3x_invoice_total">{{ total }}</span>
            </h2>
        </div>
    </div>
            
{% endblock %}

{% block javascripts %}

    $('body').on('click', '.pro3x-print-action, #print, ul#invoice-templates a', function(event) {
	event.preventDefault();
	
	var me = $(this);
	
	if(me.data('cloud') == true) {
	    $.post('{{ url('print_invoice', {'id': invoice.id}) }}', {mode: $(this).data('mode'), type: $(this).data('type')}, function(data){
		var gadget = new cloudprint.Gadget();
		gadget.setPrintDocument("text/html", "Invoice {{ invoice.id }}", data, "base64");
		
		if(me.data('back') != false) {
		    gadget.setOnCloseCallback(function(data) { window.location = '{{ path('add_invoice', {'back': app.request.get('back')}) }}'; });
		}
		
		gadget.openPrintDialog();

	    }, 'text');
	}
	else {
            var path = '{{ path('print_invoice', {'id': invoice.id}) }}';
            $.get(path, {type: $(this).data('type'), print: false, mode: me.data('mode')}, function(data) {
                if(data.msg) {
                    $('.ajax-message').append($(data.msg));
                } else {
                    $('#add_invoice_form').empty().html(data.actions);
                    $('.pro3x-invoice-mobile-menu').replaceWith(data.mobileActions);
                    $('.pro3x-customer-action').remove();
                    $('.pro3x_delete_invoice_item').remove();
                    $('.pro3x-invoice-editor').removeClass('pro3x-editable-document').addClass('pro3x-readonly-document');
                    $('.pro3x-print').empty().html(data.document);
                    $('.pro3x-invoice-title').replaceWith(data.invoiceTitle);
                    $('.pro3x-invoice-sequence').html(data.invoiceSequence);
                    $('.pro3x-invoice-title-mobile').replaceWith(data.invoiceTitleMobile);
                    $('.pro3x-editable-invoice').removeClass('pro3x-editable-invoice');
                    
                    $('.report').report('.report-template', {removeTemplate: false});
                    
                    window.print();
                }
            }, 'json');
            //window.location = '{{ path('print_invoice', {'id': invoice.id, 'back': app.request.uri}) }}' + '&type=' + $(this).data('type') + '&print=false&mode=' + me.data('mode');
	}
	
    });
    
    function addItem(form) {
	$('.actionCode', form).addClass('ajax');
    
	$.get(form.attr('action'), form.serialize(), function(data) {
	    if(data.search)
	    {
                var table = $('.pro3x_dialog table');
                table.empty();

                $.each(data.items, function(index, value) {
                        var item = $('<tr><td style="padding-left: 0px;">' + value.name + '</td><td>' + value.price + '</td></tr>');
                        item.append($('<td style="text-align: center;" class="pro3x_tools"></td>')
                            .append($('<a href="#">{{ 'odaberi'|trans }}</a>').data('code', value.code)
                            .data('amount', data.amount)
                            .data('discount', data.discount)
                            .click(function(event) { 

                        event.preventDefault();
                        var me = $(this);
                        $('.actionCode', form).val(me.data('amount') + '*' + me.data('code') + '-' + me.data('discount'));
                        $('.pro3x_dialog').modal('hide');
                        addItem(form);
                        $('.actionCode', form).val('').focus();
                        })));

                        table.append(item);
                });

                $('.pro3x_dialog').modal('show');
	    }
            else if(data.msg)
            {
                if(data.paragon == null)
                {
                    $('.paragon-box').addClass('hidden');
                }
                else if(data.paragon)
                {
                    $('.paragon').text(data.paragon);
                    $('.paragon-box').removeClass('hidden');
                }
                else
                {
                    var msg = $(data.msg);
                    msg.hide();

                    $('.ajax-message').append(msg);
                    msg.slideDown();
                }
            }
	    else
	    {
                $('tbody.pro3x_invoice_items').append($(data.item));
                $('tbody.pro3x_invoice_items .pro3x_no_data').parents('tr').remove();
                $('#mForm').before(data.mobile);
                $('.pro3x_invoice_total').text(data.total);
                $("html, body").animate({ scrollTop: $(document).height() - $(window).height() });
	    }
	    
	    $('.actionCode', form).removeClass('ajax');
	}, 'json');
    }

    $('#addProduct').click(function() {
	var form = $(this).parent();
	addItem(form);
    });
    
    $('.actionCode').keypress(function(e) {
	var code = (e.keyCode ? e.keyCode : e.which);
	if(code == 13) { //Enter keycode
	  addItem($(this).parents('form'));
	  e.preventDefault();
	  
	  $(this).val('').focus();
	}
    });
    
    $('body').on('click', '.pro3x_delete_invoice_item', function(event) { 
    
	var link = $(this);
        var target = link.data('target');
	event.preventDefault();
	
	var ajax = $('<span class="pro3x-ajax"></span>');
	link.replaceWith(ajax);
	
	$.post(link.attr('href'), null, function (data) {
	    $(target).remove();
	    $('.pro3x_invoice_total').text(data.total);

	    if($('tbody.pro3x_invoice_items td').size() == 0) {
		$('tbody.pro3x_invoice_items').append($('<tr><td colspan="100" class="pro3x_no_data">{{ 'Upišite barkod ili šifru artikla i kliknite enter ili gumb Dodaj'|trans }}</td></tr>'));
	    }
	}, 'json');
    });
    
    (function($) {

        $.fn.report = function(template, options) {

            var template = $(template);
            var report = this;
            var page = null;
            var content = null;
            var pageContent = null;
            var height = 0;
            var count = 0;

            var settings = $.extend({
                pageHeaderClass         : 'report-page-header',
                pageFooterClass         : 'report-page-footer',
                contentFooterClass      : 'report-content-footer',
                contentClass            : 'report-content',
                itemClass               : 'report-item',
                pageClass               : 'page',
                lastPageClass           : 'report-last-page',
                pageNumberClass         : 'report-page-number',
                pageCountClass          : 'report-page-count',
                clearContentSelector    : 'tbody tr',
                removeTemplate          : true
            }, options);

            function appendPage() {
                page = $('<div class="' + settings.pageClass + '"></div>');
                report.append(page);

                page.append($('.' + settings.pageHeaderClass, template).clone());
                page.append($('.' + settings.pageFooterClass, template).clone());

                pageContent = $('.' + settings.contentClass, template).clone();
                $(settings.clearContentSelector, pageContent).remove();

                content = $('tbody', pageContent);

                page.append(pageContent);

                count++;
            }

            appendPage();

            // calculate max content height
            height = page.height();

            page.children().each(function() {
                height -= $(this).innerHeight();
            });

            // generate report
            $('.' + settings.contentClass + ' .' + settings.itemClass, template).each(function() {
                var item = $(this);

                if((pageContent.height() + item.innerHeight()) > height) {
                    appendPage();
                }

                content.append(item.clone());
            });

            // append report footer
            var footer = $('.' + settings.contentFooterClass, template);

            if((pageContent.height() + footer.innerHeight()) > height) {
                appendPage();
            }

            page.append(footer.clone());

            // add last page class
            page.addClass(settings.lastPageClass);

            // enumerate pages
            $('.' + settings.pageClass, report).each(function(index) {
               $('.' + settings.pageNumberClass, this).text(index + 1);
               $('.' + settings.pageCountClass, this).text(count);
            });

            // remove template
            if(settings.removeTemplate) {
                template.remove();
            }
        };

    })(jQuery);
{% endblock %}

{% block scripts %}
    
    {{ parent() }}
    
    <div id="pro3x-edit-description" class="modal fade ag-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h4 class="modal-title">Uređivanje stavke<span class="glyphicon glyphicon-remove close" data-dismiss="modal"></span></h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label col-md-3">Opis stavke</label>
                            <div class="col-md-9">
                                <textarea id="pro3x-selected-description" class="form-control"></textarea>
                            </div>
                        </div>                    

                        <div class="form-group">
                            <label class="control-label col-md-3">Jedinična cijena</label>
                            <div class="col-md-9">
                                <input type="text" id="pro3x-item-unit-price" class="form-control" />
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="control-label col-md-3">Količina</label>
                            <div class="col-md-9">
                                <div class="input-group">
                                    <input type="text" id="pro3x-item-amount" class="form-control" />
                                    <span class="input-group-addon">
                                        <span id="pro3x-item-unit" style="width: 60px; display: inline-block;"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="control-label col-md-3">Osnovica</label>
                            <div class="col-md-9">
                                <input type="text" id="pro3x-item-base" readonly="true" class="form-control" />
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="control-label col-md-3">Popust</label>
                            <div class="col-md-9">
                                <div class="input-group">
                                    <input type="text" id="pro3x-item-discount" class="form-control" />
                                    <span class="input-group-addon">
                                        <span id="pro3x-item-unit" style="width: 60px; display: inline-block;">%</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 0px;">
                            <label class="control-label col-md-3">Ukupno</label>
                            <div class="col-md-9">
                                <input type="text" id="pro3x-item-total" readonly="true" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="pro3x-save-changed-item" class="btn btn-primary ag-btn">Spremi</button>
                    <button type="button" class="btn btn-primary ag-btn" data-dismiss="modal">Zatvori</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    
    <script>
        jQuery(document).ready(function($) {
            var self = this;
            
            self.dialog = $('#pro3x-edit-description');
            self.editor = $('#pro3x-selected-description');
            self.unitPrice = $('#pro3x-item-unit-price');
            self.amount = $('#pro3x-item-amount');
            self.totalPrice = $('#pro3x-item-base');
            self.discount = $('#pro3x-item-discount');
            self.discountPrice = $('#pro3x-item-total');
            self.unit = $('#pro3x-item-unit');
            self.invoiceTotal = $('.pro3x_invoice_total');
            
            self.data = null;
            
            self.id = function() {
                return self.item.data('id');
            };
            
            self.params = function() {
                return { 
                    'id': self.id(), 
                    'unitPrice': self.unitPrice.val(), 
                    'amount': self.amount.val(),
                    'discount': self.discount.val()
                };
            };
            
            self.calculateTotal = function() {

                var params = self.params();

                $.get('{{ path('change-item-price') }}', params, function(data) {
                    self.set(data);
                });
            };
            
            self.showLoading = function() {
                $('form .actionCode').addClass('ajax');
            };
            
            self.hideLoading = function() {
                $('form .actionCode').removeClass('ajax');
            };
            
            self.saveChangedItem = function() {
                
                self.showLoading();
                
                var params = self.params();
                params.description = self.editor.val();
                
                $.post('{{ path('save-changed-item') }}', params, function(data) {
                    self.item.parents('tr').replaceWith(data.item);
                    self.invoiceTotal.text(data.total);
                    self.hideLoading();
                });
            };
            
            self.set = function(data) {
                self.data = data;
                
                self.unitPrice.val(data.unitPrice);
                self.amount.val(data.amount);
                self.totalPrice.val(data.totalPrice);
                self.discount.val(data.discount);
                self.discountPrice.val(data.discountPrice);
                self.unit.text(data.unit);
            };
            
            $('.pro3x-table-panel').delegate('.pro3x-editable-invoice .invoice-item-description', 'click', function() {
                
                self.showLoading();
                
                self.item = $(this);
                self.editor.val(self.item.text());
                
                $.get('{{ path('get_invoice_item') }}', { 'id': self.id() }, function(data) {
                    self.hideLoading();
                    
                    self.set(data);
                    self.dialog.modal('show');
                });
            });
            
            self.unitPrice.change(function() {
                if(self.data.unitPrice != self.unitPrice.val()) {
                    self.calculateTotal();
                }
            });
            
            self.amount.change(function() {
                if(self.data.amount != self.amount.val()) {
                    self.calculateTotal();
                }
            });
            
            self.discount.change(function() {
                if(self.data.discount != self.discount.val()) {
                    self.calculateTotal();
                }
            });
            
            $('#pro3x-save-changed-item').click(function() {
                self.dialog.modal('hide');
                self.saveChangedItem();
            });
        });
    </script>
    
{% endblock %}
