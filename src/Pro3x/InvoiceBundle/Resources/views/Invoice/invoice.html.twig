{% extends '::base.html.twig' %}

{% block header %}
    <script src="http://www.google.com/cloudprint/client/cpgadget.js"></script>
    <style type="text/css">
	.ui-menu 
	    { position: absolute; width: 200px; margin-top: 10px; }
	    
	.ui-dialog-content
	    { padding: 2px 0px 2px 0px !important; }
    </style>
{% endblock %}

{% block page_title %}
    
        <span class="col-md-8" style="padding-left: 0px;">
            <img src="{{ asset('icons/small/invoice_add.png') }}" />{% if invoice.sequence is null  %}{{ 'Novi Račun'|trans|title }}{% else %}{{ 'Račun'|trans|title }} {{ invoice.sequence }}{% endif %} 
            / <a href="{{ path('edit_location', {'id': invoice.position.location.id, 'back': app.request.uri }) }}">{{ invoice.position.location.name }}</a>
            / <a href="{{ path('edit_position', {'id': invoice.position.id, 'back': app.request.uri}) }}">{{ invoice.position.name }}</a>
	</span>
        
        <span class="col-md-4" style="text-align: right; padding-right: 8px;">
            <small class="pro3x_subtitle">
                {% if invoice.originalInvoiceNumber %} Paragon: {{ invoice.originalInvoiceNumber }} {% if invoice.customer %}|{% endif %}{% endif %}

                {% if invoice.customer %} <a href="{{ path('edit_client', {'id': invoice.customer.id, 'back': app.request.uri}) }}">{{ invoice.customer.name }}</a> 
                    | <a href="{{ path('customer_history', {'customer': invoice.customer.id, 'back': app.request.uri}) }}">Kartica</a>
                {% endif %}
            </small>
        </span>
            
        <div class="clearfix"></div>
    
{% endblock %}

{% block body %}
    <div class="col-md-12" style="margin-bottom: 0.6em;">
	
	{% include '::message.html.twig' %}
	
	<form>
	    <div class="panel panel-default pro3x-table-panel">
            <table class="table table-striped table-hover table-bordered">
		<thead>
		    <tr>
			    <th class="ui-widget-header ui-corner-all" style="width: 350px;">{{ 'Naziv artikla'|trans }}</th>
			    <th class="ui-widget-header ui-corner-all">{{ 'Jedinična cijena'|trans }}</th>
			    <th class="ui-widget-header ui-corner-all">{{ 'Količina'|trans }}</th>
			    <th class="ui-widget-header ui-corner-all">{{ 'Osnovica'|trans }}</th>
			    <th class="ui-widget-header ui-corner-all">{{ 'Popust'|trans }}</th>
			    <th class="ui-widget-header ui-corner-all">{{ 'Ukupno'|trans }}</th>
		    </tr>
		</thead>

		<tbody class="pro3x_invoice_items">
		{% for item in invoice.items %}
			{% include 'Pro3xInvoiceBundle:Invoice:addItem.html.twig' with {'item': item} %}
		{% else %}
		    <tr>		    
			<td colspan="100" class="pro3x_no_data">{{ 'Upišite barkod ili šifru artikla i kliknite enter ili gumb Dodaj'|trans }}</td>
		    </tr>
		{% endfor %}
		</tbody>
	    </table>
            </div>
	</form>
    </div>

    <div class="clearfix"></div>
                
    <div class="pro3x-table-buttons">
	<div class="col-md-9">
	    <form id="add_invoice_form" class="form-horizontal" action="{{ path('add_invoice_item') }}">
		{% if invoice.sequence == null %}
		    <input type="hidden" name="invoice" value="{{ invoice.id }}" />
		    {% if invoice.tenderSequence == null %}
			<input type="text" class="form-control" id="actionCode" style="width: 225px; display: inline-block;" placeholder="Barkod, šifra ili naziv artikla" name="code" />
			<input  id="addProduct" class="btn btn-primary" type="button" name="action" value="Dodaj" />
			<a class="btn btn-primary" href="{{ path('change_invoice_customer', {'id': invoice.id, 'back': app.request.uri}) }}">{{ 'Kupac'|trans }}</a>
		    {% endif %}
		    <div style="display: inline-block; margin-right: 2px;">
                        <div class="btn-group">
                            <input  id="print" style="width: 74px;" data-mode="{{ invoice.position.location.templatesSorted[0].id }}" data-cloud="{{ invoice.position.location.templatesSorted[0].useGoogleCloud }}" class="btn btn-primary" type="button" name="action" value="Ispis" />
                            <button  id="select" class="btn btn-primary dropdown-toggle" style="width: auto;" data-toggle="dropdown" type="button" name="action" value=""><span class="caret"></span></button>
                            <ul id="invoice-templates" class="dropdown-menu" role="menu">
                                {% for item in invoice.position.location.templatesSorted %}
                                    <li><a data-cloud="{{ item.useGoogleCloud }}" data-type="auto" data-mode="{{ item.id }}" href="#">{{ item.name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
		    </div>
		    
		{% else %}
		    <div class="btn-group">
			<input style="width: 74px;"  id="print" data-back="false" data-type="invoice" data-mode="{{ invoice.template.id }}" data-cloud="" class="btn btn-primary" type="button" name="action" value="Ispis" />
                        <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown" style="width: auto;" type="button" name="action" value=""><span class="caret"></span></button>
                        <ul id="invoice-templates" class="dropdown-menu" role="menu">
                            {% if(invoice.template) %}
                            <li><a data-back="false" data-cloud="" data-type="invoice" data-mode="{{ invoice.template.id }}" href="#">Ispis računa</a></li>
                            {% endif %}
                            {% if(invoice.tenderTemplate) %}
                            <li><a data-back="false" data-cloud="" data-type="tender" data-mode="{{ invoice.template.id }}" href="#">Ispis ponude</a></li>
                            {% endif %}
                            <!-- <li><a data-back="false" data-cloud="1" data-mode="{{ invoice.template.id }}" href="#">Google Cloud Print</a></li> -->
                        </ul>
		    </div>
		    
		{% endif %}
		<a class="btn btn-primary" href="{{ path('cancel_invoice', {'id': invoice.id, 'back': app.request.get('back')}) }}">{{ 'Odustani'|trans }}</a>
	    </form>
	</div>
	<div class="col-md-3">
            <h2 style="text-align: right; margin-top: 2px; margin-right: 8px;">
                <small style="margin-right: 10px;">{{ 'Ukupno:'|trans }}</small><span class="pro3x_invoice_total">{{ total }}</span>
            </h2>
	</div>
    </div>
    
    <div class="pro3x_dialog" title="Izbor artikla">
	<table class="pro3x">
	    
	</table>
    </div>

{% endblock %}

{% block javascripts %}

    
    		
    $('#print, ul#invoice-templates a').click(function(event) {
	event.preventDefault();
	
	var me = $(this);
	
	if(me.data('cloud') == true) {
	    $.post('{{ url('print_invoice', {'id': invoice.id}) }}', {mode: $(this).data('mode'), type: $(this).data('type')}, function(data){
		var gadget = new cloudprint.Gadget();
		gadget.setPrintDocument("text/html", "Invoice {{ invoice.id }}", data, "base64");
		
		if(me.data('back') != false) {
		    gadget.setOnCloseCallback(function(data) { window.location = '{{ path('add_invoice', {'back': app.request.get('back')}) }}'; });
		}
		
		gadget.openPrintDialog();

	    }, 'text');
	}
	else if(me.data('back') != false) {
	window.location = '{{ path('print_invoice', {'id': invoice.id, 'back': app.request.get('back')}) }}' + '&type=' + $(this).data('type') + '&print=false&mode=' + me.data('mode');
	}
	else {
	window.location = '{{ path('print_invoice', {'id': invoice.id, 'back': app.request.uri}) }}' + '&type=' + $(this).data('type') + '&print=false&mode=' + me.data('mode');
	}
	
    });
    
    function addItem(form) {
	$('#actionCode').addClass('ajax');
    
	$.get(form.attr('action'), form.serialize(), function(data) {
	    if(data.search)
	    {
			var table = $('.pro3x_dialog table');
			table.empty();

			$.each(data.items, function(index, value) {
				var item = $('<tr><td>' + value.name + '</td><td>' + value.price + '</td></tr>');
				item.append($('<td class="pro3x_tools"></td>').append($('<a href="">{{ 'odaberi'|trans }}</a>').data('code', value.code).data('amount', data.amount).data('discount', data.discount).click(function(event) { 
				event.preventDefault();
				var me = $(this);
				$('#actionCode').val(me.data('amount') + '*' + me.data('code') + '-' + me.data('discount'));
				$('.pro3x_dialog').dialog( "close" );
				addItem($('#add_invoice_form'));
				$('#actionCode').val('').focus();
				})));

				table.append(item);
			});

			$('.pro3x_dialog').dialog({
				resizable: false,
				width: 640,
				height:400,
				modal: true,
				buttons: {
				"{{ 'Odustani'|trans }}": function() {
					$( this ).dialog( "close" );
				}
				}
			});
	    }
		else if(data.msg)
		{
			var msg = $(data.msg);
			msg.hide();
			
			$('.ajax-message').append(msg);
			msg.slideDown();
		}
	    else
	    {
			$('tbody').append($(data.item));
			$('tbody .pro3x_no_data').parents('tr').remove();
			$('.pro3x_invoice_total').text(data.total);
			$("html, body").animate({ scrollTop: $(document).height() - $(window).height() });
	    }
	    
	    $('#actionCode').removeClass('ajax');
	}, 'json');
    }

    $('#addProduct').click(function() {
	var form = $(this).parent();
	addItem(form);
    });
    
    $('#actionCode').keypress(function(e) {
	var code = (e.keyCode ? e.keyCode : e.which);
	if(code == 13) { //Enter keycode
	  addItem($(this).parent());
	  e.preventDefault();
	  
	  $(this).val('').focus();
	}
    });
    
    $('tbody').on('click', '.pro3x_delete_invoice_item', function(event) { 
    
	var link = $(this);
	event.preventDefault();
	
	var ajax = $('<span class="pro3x_ajax"></span>');
	link.replaceWith(ajax);
	
	$.post(link.attr('href'), null, function (data) {
	    ajax.parents('tr').remove();
	    $('.pro3x_invoice_total').text(data.total);

	    if($('tbody.pro3x_invoice_items td').size() == 0) {
		$('tbody.pro3x_invoice_items').append($('<tr><td colspan="100" class="pro3x_no_data">{{ 'Upišite barkod ili šifru artikla i kliknite enter ili gumb Dodaj'|trans }}</td></tr>'));
	    }
	}, 'json');
    });
{% endblock %}