{% extends '::form.html.twig' %}

{% block page_title %}<img src="{{ asset("icons/small/#{icon}.png") }}">{{ title|trans|capitalize }}{% endblock %}

{% block body %}
    <div class="col-md-6 col-md-offset-3">
	<form method="post" class="form-horizontal">
	    <div class="pro3x_tabs">
                
                <div id="info" class="panel panel-default">
                    <div class="panel-heading">{{ 'Osnovna svojstva'|trans }}</div>
		    <div class="panel-body pro3x-panel-form">
                        
                        <div class="form-group">
                            {{ form_label(form.name, form.name.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.name, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
                        <div class="form-group">
                            {{ form_label(form.barcode, form.barcode.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.barcode, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
                        <div class="form-group">
                            {{ form_label(form.code, form.code.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.code, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
                        <div class="form-group">
                            {{ form_label(form.unit, form.unit.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.unit, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
                    </div>
		</div>
                        
		<div id="info" class="panel panel-default">
                    <div class="panel-heading">{{ 'Kalkulacija nabavne cijene'|trans }}</div>
		    <div class="panel-body pro3x-panel-form">
                        
                        <div class="form-group">
                            {{ form_label(form.inputTaxRate, form.inputTaxRate.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.inputTaxRate, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
                        <div class="form-group">
                            {{ form_label(form.inputPrice, form.inputPrice.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.inputPrice, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
                        <div class="form-group">
                            {{ form_label(form.taxedInputPrice, form.taxedInputPrice.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.taxedInputPrice, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                           
		    </div>
		</div>
                        
		<div id="sales" class="panel panel-default">
                    <div class="panel-heading">{{ 'Kalkulacija prodajne cijene'|trans }}</div>
		    <div class="panel-body pro3x-panel-form">
                        
                        <div class="form-group">
                            {{ form_label(form.unitPrice, form.unitPrice.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.unitPrice, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
                        <div class="form-group">
                            {{ form_label(form.taxRates, form.taxRates.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                
                                {% for item in form.taxRates.children %}
                                    <div class="checkbox">
                                        <label> {{ form_widget(item) }} {{ item.vars.label }} </label>
                                    </div>
                                {% endfor %}

                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
                        <div class="form-group">
                            {{ form_label(form.taxAmount, form.taxAmount.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.taxAmount, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
                        <div class="form-group">
                            {{ form_label(form.taxedPrice, form.taxedPrice.vars.label, {'label_attr': {'class': 'control-label col-md-4'}}) }}
                            <div class="col-md-8">
                                {{ form_widget(form.taxedPrice, {'attr': {'class': 'form-control'}}) }}
                            </div>
                            <div class="clearfix"></div>
                        </div>
                            
			
		    </div>
		</div>
                
                {{ form_rest(form) }}
                
                <div class="pro3x-buttons">
                    <input type="submit" class="btn btn-primary" value="{{ 'Spremi'|trans }}" />
                    <a class="btn btn-primary" href="{{ app.request.get('back') }}">{{ 'Odustani'|trans }}</a>
                </div>
	    </div>
	</form>
    </div>
{% endblock %}
    
{% block javascripts %}

    function calculateTax(taxes, item, target, route) {
	if(item.val() != '') {
	    target.addClass('ajax');
	
	    $.get(route, {'tax-rates': taxes, 'amount': item.val()}, function(data) {
		$('#pro3x_invoicebundle_producttype_unitPrice').val(data.amount);
		$('#pro3x_invoicebundle_producttype_taxAmount').val(data.tax);
		$('#pro3x_invoicebundle_producttype_taxedPrice').val(data.total);
		target.removeClass('ajax');
	    }, 'json');
	}
    }
    
    function getTaxes() {
	var taxes = Array();
	
	$('.pro3x_checkbox_list input').each(function() {
	    if($(this).attr('checked') == 'checked') {
		taxes.push($(this).val());
	    }
	})
	
	return taxes;
    }
	
    $('#pro3x_invoicebundle_producttype_unitPrice').blur(function() {
	calculateTax(getTaxes(), $(this), $('#pro3x_invoicebundle_producttype_taxAmount'), '{{ path('calculate_total_price')}}');
    });
    
    $('#pro3x_invoicebundle_producttype_taxedPrice').blur(function() {
	calculateTax(getTaxes(), $(this), $('#pro3x_invoicebundle_producttype_taxAmount'), '{{ path('calculate_base_price')}}');
    });
    
    $('.pro3x_checkbox_list input').click(function() {
	calculateTax(getTaxes(), $('#pro3x_invoicebundle_producttype_taxedPrice'), $('#pro3x_invoicebundle_producttype_taxAmount'), '{{ path('calculate_base_price')}}');
    });
    
    function calculateInputTax(taxes, item, target, route) {
	if(item.val() != '') {
	    target.addClass('ajax');
	
	    $.get(route, {'tax-rates': taxes, 'amount': item.val()}, function(data) {
		$('#pro3x_invoicebundle_producttype_inputPrice').val(data.amount);
		$('#pro3x_invoicebundle_producttype_taxedInputPrice').val(data.total);
		target.removeClass('ajax');
	    }, 'json');
	}
    }
    
    function getInputTax() {
	var taxes = Array();
	var id = $('#pro3x_invoicebundle_producttype_inputTaxRate').val();
	
	if(id != '') taxes.push(id);
	
	return taxes;
    }
    
    $('#pro3x_invoicebundle_producttype_inputPrice').blur(function() {
	calculateInputTax(getInputTax(), $(this), $('#pro3x_invoicebundle_producttype_taxedInputPrice'), '{{ path('calculate_total_price')}}');
    });
    
    $('#pro3x_invoicebundle_producttype_inputTaxRate').change(function() {
	calculateInputTax(getInputTax(), $('#pro3x_invoicebundle_producttype_taxedInputPrice'), $('#pro3x_invoicebundle_producttype_inputPrice'), '{{ path('calculate_base_price')}}');
    });
    
    $('#pro3x_invoicebundle_producttype_taxedInputPrice').blur(function() {
	calculateInputTax(getInputTax(), $('#pro3x_invoicebundle_producttype_taxedInputPrice'), $('#pro3x_invoicebundle_producttype_inputPrice'), '{{ path('calculate_base_price')}}');
    });
    
    calculateTax(getTaxes(), $('#pro3x_invoicebundle_producttype_unitPrice'), $('#pro3x_invoicebundle_producttype_taxAmount'), '{{ path('calculate_total_price')}}');
    
    calculateInputTax(getInputTax(), $('#pro3x_invoicebundle_producttype_taxedInputPrice'), $('#pro3x_invoicebundle_producttype_inputPrice'), '{{ path('calculate_base_price')}}');
    
    
{% endblock %}